# 销售数据同步流程图

## 完整的销售数据同步逻辑

```mermaid
flowchart TD
    A[开始销售数据同步] --> B{检查时间参数}
    B -->|未指定时间| C[设置为昨天]
    B -->|指定时间| D[验证时间区间]
    
    C --> E[确保汇率数据完整]
    D --> E
    
    E --> F[计算需要的月份]
    F --> G{检查各月份汇率}
    G -->|缺少汇率| H[获取缺失月份汇率]
    G -->|汇率完整| I[获取销售统计数据]
    
    H --> H1[调用汇率API]
    H1 --> H2[同步汇率到数据库]
    H2 --> I
    
    I --> J{API调用成功?}
    J -->|失败| K[返回失败]
    J -->|成功| L[处理销售数据]
    
    L --> M[验证数据结构]
    M --> N{data.list存在?}
    N -->|不存在| O[记录错误并返回]
    N -->|存在| P[遍历店铺列表]
    
    P --> Q[提取店铺信息]
    Q --> R{提取sid成功?}
    R -->|失败| S[跳过该店铺]
    R -->|成功| T[查找店铺记录]
    
    T --> U{店铺存在?}
    U -->|不存在| V[记录警告并跳过]
    U -->|存在| W[提取货币代码]
    
    W --> X[提取date_collect数据]
    X --> Y[遍历每日销售数据]
    
    Y --> Z[解析日期和金额]
    Z --> AA{日期在区间内?}
    AA -->|否| BB[跳过该日期]
    AA -->|是| CC[获取汇率数据]
    
    CC --> DD{汇率存在?}
    DD -->|不存在| EE[记录警告并跳过]
    DD -->|存在| FF[货币转换]
    
    FF --> GG[转换为CNY]
    GG --> HH[转换为USD]
    HH --> II{销售记录存在?}
    
    II -->|存在| JJ[更新记录]
    II -->|不存在| KK[创建新记录]
    
    JJ --> LL[提交事务]
    KK --> LL
    LL --> MM{还有店铺?}
    
    MM -->|是| Q
    MM -->|否| NN[记录统计信息]
    
    S --> MM
    V --> MM
    BB --> YY{还有日期?}
    EE --> YY
    YY -->|是| Y
    YY -->|否| MM
    
    NN --> OO[返回成功]
    K --> PP[结束]
    O --> PP
    OO --> PP
```

## 关键组件说明

### 1. 货币转换方法 (convert_currency)
```mermaid
flowchart TD
    A[输入: amount, from_currency, to_currency, exchange_rate, usd_rate] --> B{源货币 == 目标货币?}
    B -->|是| C[直接返回金额]
    B -->|否| D{目标货币是CNY?}
    
    D -->|是| E{源货币是CNY?}
    E -->|是| F[直接返回]
    E -->|否| G[金额 × 汇率]
    
    D -->|否| H{目标货币是USD?}
    H -->|是| I{源货币是USD?}
    I -->|是| J[直接返回]
    I -->|否| K{源货币是CNY?}
    
    K -->|是| L[金额 ÷ USD汇率]
    K -->|否| M[先转CNY再转USD]
    
    G --> N[返回结果]
    J --> N
    L --> N
    M --> N
    C --> N
    F --> N
```

### 2. 汇率检查方法 (ensure_exchange_rates_for_period)
```mermaid
flowchart TD
    A[输入: start_date, end_date] --> B[计算时间区间内的月份]
    B --> C[遍历每个月份]
    C --> D{该月份有汇率数据?}
    D -->|有| E{还有月份?}
    D -->|无| F[添加到缺失列表]
    
    F --> E
    E -->|是| C
    E -->|否| G{有缺失月份?}
    
    G -->|无| H[返回成功]
    G -->|有| I[遍历缺失月份]
    
    I --> J[调用汇率API]
    J --> K{API成功?}
    K -->|失败| L[返回失败]
    K -->|成功| M[同步到数据库]
    
    M --> N{同步成功?}
    N -->|失败| L
    N -->|成功| O{还有缺失月份?}
    
    O -->|是| I
    O -->|否| H
```

## 数据流说明

### 输入数据结构
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "sid": "店铺ID",
        "currency_code": "货币代码",
        "date_collect": {
          "2025-01-01": "1000.00",
          "2025-01-02": "1500.00"
        }
      }
    ]
  }
}
```

### 数据库表关系
- `shops.shop_id` ↔ `sales.shop_id` (外键关系)
- `sales` 表存储转换后的 `cny_amount` 和 `usd_amount`
- `exchange_rate` 表提供货币转换汇率

### 错误处理策略
1. **数据验证**: 检查必要字段存在性
2. **汇率缺失**: 自动获取缺失月份的汇率数据
3. **店铺不存在**: 记录警告但继续处理其他店铺
4. **日期格式错误**: 跳过该条记录但继续处理
5. **货币转换失败**: 记录错误并跳过该条记录

### 性能优化
1. **批量处理**: 按店铺分组提交事务
2. **汇率缓存**: 预先检查并获取所需汇率数据
3. **增量更新**: 只处理指定时间区间内的数据
4. **错误恢复**: 单条记录失败不影响整体处理